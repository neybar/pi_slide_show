$spacing: .5em;

body {
        background-color: black;
}
div.shelf {
    overflow: hidden;
}
div#top_row, div#bottom_row {
    position: relative;
    overflow: hidden;
}
div#bottom_row {
    padding-top: $spacing;
}
.photo {
    position: relative;
    height: 100%;
}
.photo:last-child .img_box {
    margin-right: 0;
}
.img_box {
    margin-right: $spacing;
    overflow: hidden;
    position: relative;
    left: 0;
    height: 100%;

    img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        object-position: center center;
    }
}
.img_box + .img_box {
    margin-top: $spacing;
}
.portrait {
    max-width: 113.8%; /* Some sort of sane default, but will override */
}

div#photo_store {
    display: none;
}

div.album_name {
    position: absolute;
    color: white;
    mix-blend-mode: difference;
    bottom: 1em;
    text-align: center;
    font-size: 3em;
    width: 100%;
    text-shadow:
        1px 1px 2px rgba(0, 0, 0, 0.3),
        -1px -1px 2px rgba(0, 0, 0, 0.3),
        1px -1px 2px rgba(0, 0, 0, 0.3),
        -1px 1px 2px rgba(0, 0, 0, 0.3);
}

// Panorama container - fills vertical space with horizontal overflow
.panorama-container {
    height: 100%;

    .img_box {
        width: calc(100% - #{$spacing});
        height: 100%;
        margin-right: $spacing;
        overflow: hidden;
    }

    img {
        height: 100%;
        width: auto;
        max-width: none;
        max-height: 100%;
        object-fit: contain;
        object-position: left center;
    }
}

// Panorama overflow - panning animation for images wider than container
.panorama-overflow {
    img {
        animation: panorama-pan var(--pan-duration, 30s) ease-in-out infinite alternate;
    }
}

// Ensure height propagates through Pure CSS grid for panoramas
div.shelf .pure-g {
    height: 100%;
}

// Override Pure CSS inline-block to allow flex stretch
div.shelf .photo.panorama-container {
    display: flex;
    height: 100%;
}

// Stacked landscapes - two landscape photos in a single 1-column slot
// Each photo takes half the vertical space
.stacked-landscapes {
    display: flex;
    flex-direction: column;
    height: 100%;

    .img_box {
        height: calc(50% - #{$spacing} * 0.5); // Half height minus half spacing
        margin-right: $spacing;
        overflow: hidden;

        &:first-child {
            margin-bottom: calc(#{$spacing} * 0.5);
        }

        &:last-child {
            margin-top: calc(#{$spacing} * 0.5);
        }

        img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: center center;
        }
    }

    // Reset the margin-top rule from .img_box + .img_box
    .img_box + .img_box {
        margin-top: calc(#{$spacing} * 0.5);
    }
}

// Keyframes for panorama panning animation
// Uses CSS custom property --pan-distance set by JavaScript
@keyframes panorama-pan {
    0% {
        transform: translateX(0);
    }
    100% {
        transform: translateX(var(--pan-distance, 0));
    }
}

// =============================================================================
// Three-Phase Photo Swap Animation Variables
// =============================================================================
// Phase A: Shrink-to-corner (400ms) - old photo shrinks towards corner
// Phase B: Gravity fill (800ms) - adjacent photos slide with bounce effect
// Phase C: Slide-in (800ms) - new photo enters with bounce effect

$shrink-duration: 400ms;
$gravity-duration: 300ms;
$slide-in-duration: 800ms;

// Legacy duration alias for backwards compatibility
$slide-duration: $slide-in-duration;

// Bounce amplitudes (decreasing like a heavy ball)
// Used by both gravity-bounce (Phase B) and slide-in (Phase C) animations
$bounce-1: 10%;  // First bounce - largest
$bounce-2: 4%;   // Second bounce - medium
$bounce-3: 1.5%; // Third bounce - small settling

// =============================================================================
// Shrink-to-Corner Animations (Phase A)
// =============================================================================
// Photo shrinks towards a corner based on direction and shelf position
// Corner selection: left+top→bottom-left, left+bottom→top-left,
//                   right+top→bottom-right, right+bottom→top-right

// Shrink to bottom-left corner (for left direction on top shelf)
@keyframes shrink-to-bottom-left {
    0% {
        transform: scale(1);
        transform-origin: bottom left;
        opacity: 1;
    }
    100% {
        transform: scale(0);
        transform-origin: bottom left;
        opacity: 0;
    }
}

// Shrink to top-left corner (for left direction on bottom shelf)
@keyframes shrink-to-top-left {
    0% {
        transform: scale(1);
        transform-origin: top left;
        opacity: 1;
    }
    100% {
        transform: scale(0);
        transform-origin: top left;
        opacity: 0;
    }
}

// Shrink to bottom-right corner (for right direction on top shelf)
@keyframes shrink-to-bottom-right {
    0% {
        transform: scale(1);
        transform-origin: bottom right;
        opacity: 1;
    }
    100% {
        transform: scale(0);
        transform-origin: bottom right;
        opacity: 0;
    }
}

// Shrink to top-right corner (for right direction on bottom shelf)
@keyframes shrink-to-top-right {
    0% {
        transform: scale(1);
        transform-origin: top right;
        opacity: 1;
    }
    100% {
        transform: scale(0);
        transform-origin: top right;
        opacity: 0;
    }
}

// Shrink animation classes
.shrink-to-bottom-left {
    animation: shrink-to-bottom-left $shrink-duration ease-in forwards;
}

.shrink-to-top-left {
    animation: shrink-to-top-left $shrink-duration ease-in forwards;
}

.shrink-to-bottom-right {
    animation: shrink-to-bottom-right $shrink-duration ease-in forwards;
}

.shrink-to-top-right {
    animation: shrink-to-top-right $shrink-duration ease-in forwards;
}

// =============================================================================
// Instant Vanish (Progressive Enhancement Fallback)
// =============================================================================
// For low-powered devices (older Raspberry Pis) or users preferring reduced motion
// Triggers on: prefers-reduced-motion OR manual ENABLE_SHRINK_ANIMATION=false

.instant-vanish {
    opacity: 0 !important;
    transition: none !important;
    animation: none !important;
}

// Respect user's motion preferences
@media (prefers-reduced-motion: reduce) {
    .shrink-to-bottom-left,
    .shrink-to-top-left,
    .shrink-to-bottom-right,
    .shrink-to-top-right {
        animation: none;
        opacity: 0;
    }
}

// =============================================================================
// Gravity Fill Animations (Phase B) - with bounce effect
// =============================================================================
// FLIP technique: After old photos are removed from DOM, layout reflows and
// remaining photos are at their NEW positions. We offset them back to their
// OLD visual positions, then animate to NEW positions with bounce.
// Uses CSS custom properties:
// --gravity-offset: initial displacement in pixels (from FLIP calculation)
// --bounce-sign: 1 for rightward bounce, -1 for leftward bounce

@keyframes gravity-bounce {
    0% {
        transform: translateX(var(--gravity-offset, 0px));
    }
    35% {
        transform: translateX(0); // Arrive at final position
    }
    50% {
        // First bounce - overshoot in direction opposite to movement
        transform: translateX(calc(var(--bounce-sign, 1) * $bounce-1));
    }
    62% {
        transform: translateX(0); // Rebound to position
    }
    74% {
        // Second bounce - smaller
        transform: translateX(calc(var(--bounce-sign, 1) * $bounce-2));
    }
    84% {
        transform: translateX(0); // Rebound again
    }
    92% {
        // Third tiny bounce
        transform: translateX(calc(var(--bounce-sign, 1) * $bounce-3));
    }
    100% {
        transform: translateX(0); // Settled
    }
}

// Gravity bounce animation class - uses same duration as slide-in for consistency
.gravity-bounce {
    animation: gravity-bounce $slide-in-duration ease-out forwards;
}

// =============================================================================
// Phase C: Slide-in Animations (with bounce)
// =============================================================================
// Slide-in with heavy ball bounce effect
// Physics: Photo slides in, then bounces 2-3 times with decreasing amplitude
// Duration: 800ms for smooth rendering and visible bounce effect
// Bounce amplitudes defined above with Phase B variables

// --- Slide-in Animations (with heavy ball bounce) ---

// Slide in from top (drops down, bounces down then settles)
@keyframes slide-in-from-top {
    0% {
        transform: translateY(-100%);
        opacity: 0;
    }
    5% {
        opacity: 1;
    }
    35% {
        transform: translateY(0); // Arrives at final position
    }
    50% {
        transform: translateY($bounce-1); // First bounce - overshoots down
    }
    62% {
        transform: translateY(0); // Rebounds to position
    }
    74% {
        transform: translateY($bounce-2); // Second bounce - smaller
    }
    84% {
        transform: translateY(0); // Rebounds again
    }
    92% {
        transform: translateY($bounce-3); // Third tiny bounce
    }
    100% {
        transform: translateY(0); // Settled
        opacity: 1;
    }
}

// Slide in from bottom (rises up, bounces up then settles)
@keyframes slide-in-from-bottom {
    0% {
        transform: translateY(100%);
        opacity: 0;
    }
    5% {
        opacity: 1;
    }
    35% {
        transform: translateY(0);
    }
    50% {
        transform: translateY(-$bounce-1); // First bounce - overshoots up
    }
    62% {
        transform: translateY(0);
    }
    74% {
        transform: translateY(-$bounce-2); // Second bounce
    }
    84% {
        transform: translateY(0);
    }
    92% {
        transform: translateY(-$bounce-3); // Third tiny bounce
    }
    100% {
        transform: translateY(0);
        opacity: 1;
    }
}

// Slide in from left (slides right, bounces right then settles)
@keyframes slide-in-from-left {
    0% {
        transform: translateX(-100%);
        opacity: 0;
    }
    5% {
        opacity: 1;
    }
    35% {
        transform: translateX(0);
    }
    50% {
        transform: translateX($bounce-1); // First bounce - overshoots right
    }
    62% {
        transform: translateX(0);
    }
    74% {
        transform: translateX($bounce-2); // Second bounce
    }
    84% {
        transform: translateX(0);
    }
    92% {
        transform: translateX($bounce-3); // Third tiny bounce
    }
    100% {
        transform: translateX(0);
        opacity: 1;
    }
}

// Slide in from right (slides left, bounces left then settles)
@keyframes slide-in-from-right {
    0% {
        transform: translateX(100%);
        opacity: 0;
    }
    5% {
        opacity: 1;
    }
    35% {
        transform: translateX(0);
    }
    50% {
        transform: translateX(-$bounce-1); // First bounce - overshoots left
    }
    62% {
        transform: translateX(0);
    }
    74% {
        transform: translateX(-$bounce-2); // Second bounce
    }
    84% {
        transform: translateX(0);
    }
    92% {
        transform: translateX(-$bounce-3); // Third tiny bounce
    }
    100% {
        transform: translateX(0);
        opacity: 1;
    }
}

// --- Slide-out Animations (left/right only, no bounce) ---
// Note: Up/down slide-out removed - replaced by shrink-to-corner animation

@keyframes slide-out-to-left {
    0% {
        transform: translateX(0);
        opacity: 1;
    }
    100% {
        transform: translateX(-100%);
        opacity: 0;
    }
}

@keyframes slide-out-to-right {
    0% {
        transform: translateX(0);
        opacity: 1;
    }
    100% {
        transform: translateX(100%);
        opacity: 0;
    }
}

// --- Animation Classes ---

// Slide-in classes (with bounce) - 800ms duration
.slide-in-from-top {
    animation: slide-in-from-top $slide-in-duration ease-out forwards;
}

.slide-in-from-bottom {
    animation: slide-in-from-bottom $slide-in-duration ease-out forwards;
}

.slide-in-from-left {
    animation: slide-in-from-left $slide-in-duration ease-out forwards;
}

.slide-in-from-right {
    animation: slide-in-from-right $slide-in-duration ease-out forwards;
}

// Slide-out classes (left/right only, no bounce)
// z-index: -1 ensures departing photos slide behind their neighbors
// Note: Up/down slide-out classes removed - replaced by shrink-to-corner animation

.slide-out-to-left {
    animation: slide-out-to-left $slide-duration ease-in forwards;
    z-index: -1;
}

.slide-out-to-right {
    animation: slide-out-to-right $slide-duration ease-in forwards;
    z-index: -1;
}

// Ensure .photo elements can contain animated children
.photo {
    overflow: hidden;
}
